<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>강좌 상세</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>

<div th:replace="fragments/header :: headerFragment"></div>

<div class="container">
    <h1 th:text="${course.title}">강좌 제목</h1>

    <div>
        <p><strong>설명:</strong> <span th:text="${course.description}">강좌 설명</span></p>
        <p><strong>가격:</strong> <span th:text="${course.price}">50000</span></p>
        <p><strong>상태:</strong> <span th:text="${course.courseStatus}">ACTIVE</span></p>
        <p><strong>카테고리:</strong> <span th:text="${course.category?.name}">프로그래밍</span></p>
        <p><strong>강사:</strong> <span th:text="${course.instructor?.nickname}">강사명</span></p>
        <p><strong>생성일:</strong> <span th:text="${#temporals.format(course.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
    </div>

    <div class="action-buttons" style="margin: 20px 0;">
        <!--        enrollment progress bar-->
        <div th:if="${isEnrolled != null and isEnrolled}" style="margin-bottom: 10px;">
            <p><strong>수강 진행률:</strong> <span th:text="${enrollment.progressPercentage}">0</span>%</p>
            <div class="progress" style="width: 100%; background-color: #e0e0e0; border-radius: 5px;">
                <div class="progress-bar" th:style="'width: ' + ${enrollment.progressPercentage} + '%; background-color: #4caf50; height: 20px; border-radius: 5px;'"></div>
            </div>
        </div>

        <form th:if="${isEnrolled == null or !isEnrolled}"
              th:action="@{/cart/add/{courseId}(courseId=${course.id})}"
              method="post"
              style="display: inline;">
            <input type="hidden" name="courseId" th:value="${course.id}" />
            <button type="submit" class="btn btn-secondary">🛒 장바구니 담기</button>
        </form>
    </div>

    <h2>강의 목록</h2>
    <table class="table">
        <thead>
        <tr>
            <th>순서</th>
            <th>강의명</th>
            <th>URL</th>
            <th th:if="${isEnrolled != null and isEnrolled}">수강</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="lecture : ${course.lectures}">
            <td th:text="${lecture.lectureOrder}">1</td>
            <td th:text="${lecture.title}">강의 제목</td>
            <td th:text="${lecture.contentUrl}">URL</td>
            <!-- enrollment가 true라면, 해당 강의들에 대해 active button 생성 -->
            <td th:if="${isEnrolled != null and isEnrolled}">
                <!-- 완료되지 않은 경우: 수강하기 버튼 -->
                <form th:if="${!completedLectureIds.contains(lecture.id)}"
                      th:action="@{/enrollment/{enrollmentId}/completeLecture/{lectureId}(enrollmentId=${enrollment.id}, lectureId=${lecture.id})}"
                      method="post"
                      style="margin: 0;">
                    <button type="submit" class="btn btn-primary">
                        ▶ 수강하기
                    </button>
                </form>

                <!-- 완료된 경우: 비활성화 버튼 -->
                <button th:if="${completedLectureIds.contains(lecture.id)}"
                        class="btn btn-secondary"
                        disabled
                        style="cursor: not-allowed; opacity: 0.6;">
                    ✓ 수강 완료
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <div style="margin-top: 20px;">
        <a th:href="@{/courses/{id}/edit(id=${course.id})}" class="btn">수정</a>
        <a href="/courses" class="btn btn-secondary">목록으로</a>
    </div>
</div>
</body>
</html>
